<!DOCTYPE html>
<html>
<head>
<title>Sign-in</title>
</head>
<body>

<h1>Sign-in</h1>
<p id="content">This is a paragraph.</p>

<form onsubmit="event.preventDefault(); submitcode();">
  <select name="sign" id="sign" onchange="signChange()" required>
    <option value="" selected disabled hidden>-- Signin or signout --</option>
    <option value="in">Sign in</option>
    <option value="out">Sign out</option>
  </select><br>
  
  <input id="email" type="email" name="email" pattern=".+\..+@lphs\.school\.nz" placeholder="School Email" hidden required><br>
  
  <select name="inreason" id="inreason" onchange="reasonChange(1)" required hidden>
    <option value="" id="indef" selected disabled hidden>-- Reason --</option>
    <option value="Late">Late</option>
    <option value="Appointment">Appointment</option>
    <option value="other">Other</option>
  </select>
  <input placeholder="Reason" id="inother" hidden>
  
  
  <select name="outreason" id="outreason" onchange="reasonChange(2)" required hidden>
    <option value="" id="outdef" selected disabled hidden>-- Reason --</option>
    <option value="Year 13">Year 13</option>
    <option value="Appointment">Appointment</option>
    <option value="other">Other</option>
  </select>
  <input placeholder="Reason" id="outother" hidden>
  
  <br>
  <input type="submit">
</form><br>

<button onclick="getData();">getData</button><br>
<button onclick="sheetLog('In', 'Name', 'Test');">sheetLog</button><br>
<button onclick="cardLog('Name', 'B5:6D:39:38:F6:F4');">cardLog</button><br>
<script>
function signChange(){
  var inoutstr = document.getElementById("sign").value;
  var outinstr;
  if(inoutstr == "in"){
  	outinstr = "out";
  }else{
    outinstr = "in";
  }
  document.getElementById(inoutstr+"reason").hidden = false;
  document.getElementById(inoutstr+"reason").required = true;
  document.getElementById(inoutstr+"other").hidden = true;

  document.getElementById(outinstr+"reason").hidden = true;
  document.getElementById(outinstr+"reason").required = false;
  document.getElementById(outinstr+"other").hidden = true;
  
  document.getElementById("email").hidden = false;
  document.getElementById("def").selected = true;
  document.getElementById("indef").selected = true;
}

function reasonChange(inout){
  var inoutstr;
  if(inout == 1){
    inoutstr = "in";
  }else{
    inoutstr = "out";
  }
  if(document.getElementById(inoutstr+"reason").value == "other"){
    document.getElementById(inoutstr+"other").hidden = false;
    document.getElementById(inoutstr+"other").required = true;
  }else{
    document.getElementById(inoutstr+"other").hidden = true;
    document.getElementById(inoutstr+"other").required = false;
  }
}

function submitcode(){
  var inout = document.getElementById("sign").value;
  var email = document.getElementById("email").value;
  var reason = document.getElementById(inout+"reason").value;
  if(sheetLog(inout, email, reason)){
  	alert("Signed "+inout);
  }else{
    alert("Falied to sign "+inout+". Please try again.");
  }
}

var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6l7S2KUZZG_v6Ks1nLkFMGOZRrxmIVK6B2g3rSN0bHsBp82ss2MmiUAgrwqYBC08R/exec";

async function sheetLog(inout, name, reason){
  try {
    const response = await fetch(SCRIPT_URL+"?met=1&inout="+inout+"&name="+name+"&reason="+reason, {mode: 'no-cors'});
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
    }
    const tex = await response.text();
    if(tex == "ERROR"){
      console.error("Error occured form google sheets api when calling function sheetLog");
    }
  } catch (error) {
    console.error(error.message);
  }
}

async function cardLog(name, data){
  try {
    const response = await fetch(SCRIPT_URL+"?met=2&name="+name+"&data="+data, {mode: 'no-cors'});
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
      return false;
    }
    const tex = await response.text();
    if(tex == "ERROR"){
      console.error("Error occured form google sheets api when calling function sheetLog");
      return false;
    }else{
      return true;
    }
  } catch (error) {
    console.error(error.message);
  }
  return false;
}

async function getData() {
  try {
    const response = await fetch(SCRIPT_URL+"?met=0");
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
    }
    const tex = await response.text();
    if(tex == "ERROR"){
      console.error("Error occured form google sheets api when calling function getData");
      return;
    }
    document.getElementById("content").innerHTML = tex;
  } catch (error) {
    console.error(error.message);
  }
}
</script>
  
</body>
</html>
